name: iOS Build IPA (Non signÃ©)

# Workflow simple pour gÃ©nÃ©rer un IPA non signÃ©
# Ã€ installer avec Sideloadly, AltStore, ou tout outil de sideload

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-unsigned-ipa:
    runs-on: macos-latest

    env:
      APP_NAME: C6Radio

    steps:
      # ============================================
      # Ã‰TAPE 1 : RÃ©cupÃ©ration du code source
      # ============================================
      - name: Checkout du code
        uses: actions/checkout@v4

      # ============================================
      # Ã‰TAPE 2 : Configuration Node.js
      # ============================================
      - name: Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      # ============================================
      # Ã‰TAPE 3 : Installation des dÃ©pendances
      # ============================================
      - name: Installation des dÃ©pendances npm
        run: npm ci

      # ============================================
      # Ã‰TAPE 4 : Build Vite (gÃ©nÃ¨re le dossier dist/)
      # ============================================
      - name: Build React + Vite
        run: npm run build
        env:
          VITE_STREAM_URL: https://radio.c6media.fr:8443/main
          VITE_NOW_PLAYING_URL: https://radio.c6media.fr/api/live-info
          VITE_WP_API_BASE_URL: https://exp937.fr/wp/wp-json/wp/v2

      # ============================================
      # Ã‰TAPE 5 : Synchronisation Capacitor iOS
      # ============================================
      - name: Synchronisation Capacitor iOS
        run: npx cap sync ios
      
      # ============================================
      # Ã‰TAPE 5.5 : Ajouter Firebase au Package.swift
      # (cap sync rÃ©gÃ©nÃ¨re Package.swift, on doit rÃ©-ajouter Firebase)
      # ============================================
      - name: Ajouter Firebase aux dÃ©pendances SPM
        run: |
          # Backup du Package.swift original
          cp ios/App/CapApp-SPM/Package.swift ios/App/CapApp-SPM/Package.swift.backup
          
          # Ajouter Firebase Ã  la liste des dÃ©pendances
          sed -i '' 's|.package(name: "CapacitorPushNotifications", path: "../../../node_modules/@capacitor/push-notifications")|.package(name: "CapacitorPushNotifications", path: "../../../node_modules/@capacitor/push-notifications"),\
                .package(url: "https://github.com/firebase/firebase-ios-sdk.git", from: "10.0.0")|' ios/App/CapApp-SPM/Package.swift
          
          # Ajouter FirebaseMessaging aux targets (inclut automatiquement FirebaseCore)
          sed -i '' 's|.product(name: "CapacitorPushNotifications", package: "CapacitorPushNotifications")|.product(name: "CapacitorPushNotifications", package: "CapacitorPushNotifications"),\
                .product(name: "FirebaseMessaging", package: "firebase-ios-sdk")|' ios/App/CapApp-SPM/Package.swift
          
          # Afficher le rÃ©sultat
          echo "ğŸ“¦ Package.swift modifiÃ©:"
          cat ios/App/CapApp-SPM/Package.swift
      
      # ============================================
      # Ã‰TAPE 5.6 : RÃ©solution des packages SPM
      # ============================================
      - name: RÃ©solution automatique des packages SPM
        run: |
          xcodebuild -resolvePackageDependencies \
            -project ios/App/App.xcodeproj \
            -scheme App

      # ============================================
      # Ã‰TAPE 6 : IncrÃ©mentation du build number
      # ============================================
      - name: IncrÃ©mentation du build number
        run: |
          BUILD_NUMBER=${{ github.run_number }}
          xcrun agvtool new-version -all $BUILD_NUMBER
        working-directory: ios/App

      # ============================================
      # Ã‰TAPE 7 : Configuration pour build non signÃ©
      # On dÃ©sactive la signature de code
      # ============================================
      - name: Configuration build non signÃ©
        run: |
          # DÃ©sactive la signature de code
          sed -i '' 's/CODE_SIGN_STYLE = Manual;/CODE_SIGN_STYLE = Manual;\
          CODE_SIGN_IDENTITY = "";/' ios/App/App.xcodeproj/project.pbxproj
          
          # Active la gÃ©nÃ©ration d'archive sans signature
          sed -i '' 's/CODE_SIGN_IDENTITY = "Apple Distribution";/CODE_SIGN_IDENTITY = "";/' ios/App/App.xcodeproj/project.pbxproj

      # ============================================
      # Ã‰TAPE 8 : Build Xcode en mode Debug (pas de signature requise)
      # ============================================
      - name: Build Xcode (Debug, sans signature)
        run: |
          xcodebuild \
            -project ios/App/App.xcodeproj \
            -scheme App \
            -configuration Debug \
            -sdk iphoneos \
            -archivePath build/App.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            archive

      # ============================================
      # Ã‰TAPE 9 : CrÃ©er l'IPA Ã  partir de l'archive
      # ============================================
      - name: CrÃ©er l'IPA
        run: |
          # CrÃ©er le dossier Payload
          mkdir -p build/Payload
          
          # Copier l'app dans Payload
          cp -R build/App.xcarchive/Products/Applications/App.app build/Payload/
          
          # CrÃ©er le fichier IPA (c'est juste un zip du dossier Payload)
          cd build
          zip -r C6Radio-unsigned.ipa Payload
          
          # Nettoyer
          rm -rf Payload
          
          echo "âœ… IPA crÃ©Ã© : build/C6Radio-unsigned.ipa"
          ls -lh C6Radio-unsigned.ipa

      # ============================================
      # Ã‰TAPE 10 : Upload de l'IPA comme artifact
      # ============================================
      - name: Upload IPA comme artifact
        uses: actions/upload-artifact@v4
        with:
          name: C6Radio-unsigned-${{ github.run_number }}
          path: build/C6Radio-unsigned.ipa
          retention-days: 30

      # ============================================
      # Ã‰TAPE 11 : Afficher les instructions
      # ============================================
      - name: Instructions d'installation
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ BUILD RÃ‰USSI !"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“± Pour installer sur ton iPhone :"
          echo ""
          echo "1. Va sur GitHub Actions (cet onglet)"
          echo "2. Clique sur ce workflow"
          echo "3. Descends jusqu'Ã  'Artifacts'"
          echo "4. TÃ©lÃ©charge : C6Radio-unsigned-${{ github.run_number }}.zip"
          echo "5. DÃ©zippe le fichier â†’ Tu obtiens C6Radio-unsigned.ipa"
          echo ""
          echo "ğŸ”§ Avec Sideloadly :"
          echo "   - Ouvre Sideloadly"
          echo "   - Connecte ton iPhone en USB"
          echo "   - Glisse-dÃ©pose le fichier .ipa"
          echo "   - Entre ton Apple ID"
          echo "   - Installe !"
          echo ""
          echo "ğŸ”§ Avec AltStore :"
          echo "   - Ouvre AltStore sur ton iPhone"
          echo "   - My Apps â†’ +"
          echo "   - SÃ©lectionne le fichier .ipa"
          echo ""
          echo "âš ï¸  Important :"
          echo "   - L'app sera valide 7 jours"
          echo "   - AprÃ¨s 7 jours, rÃ©installe une nouvelle version"
          echo "   - Ou utilise un compte Apple Developer (valide 1 an)"
          echo ""
          echo "ğŸ”¢ Build number : ${{ github.run_number }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

